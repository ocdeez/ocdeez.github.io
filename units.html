<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Units — OCEMS</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header>
  <div class="container">
    <h1>OCEMS — Unit Statuses</h1>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/units.html">Units</a>
      <a href="/current-cfs.html">Current CFS</a>
    </nav>
    <div class="meta">
      <span id="lastUpdated">Last updated: —</span>
      <span id="error" class="error" hidden></span>
    </div>
  </div>
</header>

<!-- Mobile cards -->
<div class="container mobileOnly">
  <div id="sections" class="sections"></div>
</div>

<!-- Desktop table -->
<main class="container desktopOnly">
  <table>
    <thead>
    <tr>
      <th>CAD Unit</th>
      <th>Status</th>
      <th>Details</th>
      <th>CFS #</th>
      <th>Location</th>
    </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="5" class="muted">Loading…</td></tr>
    </tbody>
  </table>
</main>

<script>
/* Error overlay */
(function(){
  function showErr(label, detail){
    let el = document.getElementById('error');
    if (!el) {
      el = document.createElement('pre');
      el.id = 'error';
      el.style.color = '#ff6b6b';
      el.style.padding = '1rem';
      el.style.whiteSpace = 'pre-wrap';
      document.body.prepend(el);
    }
    el.hidden = false;
    el.textContent = '['+label+'] ' + (detail?.message || detail || '');
  }
  window.addEventListener('error', e => showErr('JS Error', e.error || e.message));
  window.addEventListener('unhandledrejection', e => showErr('Promise Rejection', e.reason));
})();

/* ---------- CONFIG ---------- */
const PROXY = 'https://api.stancfhole.com';

/* Sticky + allowed lists */
const STICKY_UNITS = ['M931','M932','M933','M934','M935','M936','M937','M938','M939'];
const ALLOW_UNITS = new Set([
  ...STICKY_UNITS,
  '93','93HLD','905','906','907','908','909','911','912','913','914','915','917','918','919','920','921','922',
  '924','925','926','927','928','929','940','941','943','947','956',
  '9301','9302','9303','9304','9305','9306','9307','9308','9309','9310','9311','9312','9313','9314','9315','9316','9317',
  '9320','9321','9322','9323','9324','9325','9326','9327','9328','9329','9330','9331','9332','9333','9334','9335','9336','9337','9338','9339',
  '9340','9341','9342','9343','9344','9345','9346','9347','9348','9349',
  '9350','9351','9352','9353','9354','9355','9356',
  '9383','9391','9392'
]);

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
function esc(s){ s = s==null? '' : String(s);
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function naturalAZ(a,b){ return String(a).localeCompare(String(b), undefined, {numeric:true, sensitivity:'base'}); }
function normalizeUnit(u){ return String(u||'').replace(/[^A-Za-z0-9]/g,''); }
function normStatus(s){ return String(s||'').trim().toLowerCase().replace(/[_-]/g,' ').replace(/\s+/g,' '); }
function titleCase(s){ return String(s||'').replace(/\w\S*/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase()); }
function isOffDuty(text){ return normStatus(text) === 'off duty'; }

/* Optional local status mapping if unit_statuses.json exists */
let STATUS_MAP=null;
async function loadStatusMap(){
  try { const r=await fetch('/unit_statuses.json',{cache:'no-store'}); if(r.ok) STATUS_MAP=await r.json(); } catch{}
}
function mapStatus(code, desc){
  if (desc && String(desc).trim()) return String(desc);
  if (!code || !STATUS_MAP) return String(code||'');
  const k = String(code);
  return STATUS_MAP[k]?.text || STATUS_MAP[k.toUpperCase?.()]?.text || k;
}

/* Color palette for statuses (extendable; safe defaults for all we saw) */
const STATUS_COLORS = (() => {
  const m = new Map();

  // Core
  m.set('available', '#2ECC71');
  m.set('on air',   '#34D399');   // treated as Available group
  m.set('busy',     '#9CA3AF');
  m.set('poc',      '#9CA3AF');
  m.set('ems supervisor/poc', '#9CA3AF');

  // Common operations
  m.set('enroute', '#3B82F6');
  m.set('backup enroute', '#60A5FA');
  m.set('assigned', '#60A5FA');
  m.set('on scene', '#F59E0B');
  m.set('transporting', '#A78BFA');
  m.set('to hospital', '#A78BFA');
  m.set('at hospital', '#C084FC');
  m.set('patient contact', '#F97316');
  m.set('staged', '#FBBF24');
  m.set('stacked', '#FDE047');
  m.set('in area', '#22D3EE');

  // Admin/other
  m.set('in training', '#93C5FD');
  m.set('train', '#93C5FD');
  m.set('at station', '#D1D5DB');
  m.set('at home', '#D1D5DB');
  m.set('cross-staffed', '#14B8A6');
  m.set('equipment maintenance', '#A3A3A3');
  m.set('house watch/extra patrol', '#94A3B8');
  m.set('court', '#9CA3AF');
  m.set('city overtime', '#9CA3AF');
  m.set('unavailable', '#9CA3AF');

  // Events
  m.set('distress', '#EF4444');
  m.set('detained', '#E11D48');
  m.set('k 9 deployed', '#22C55E'); // normalize: 'k-9 deployed' -> 'k 9 deployed'
  m.set('arrived at', '#22C55E');
  m.set('leaving scene to', '#38BDF8');

  // 10-codes / misc
  m.set('10 15', '#9CA3AF');
  m.set('10 8/on cell phone', '#9CA3AF');
  m.set('on call', '#6EE7B7');
  m.set('vehicle search', '#0EA5E9');

  // Off duty left gray (hidden for non-sticky)
  m.set('off duty', '#6B7280');

  return {
    colorFor(text){
      const n = normStatus(text).replace(/-/g,' ').replace(/\s+/g,' ');
      return m.get(n) || '#E6E6E6';
    }
  };
})();

/* Grouping: 
   - "Available" group includes Available + On Air
   - "Busy" group includes Busy + POC
   - All other statuses become their own groups (title-cased)
*/
function groupNameFor(statusText){
  const n = normStatus(statusText);
  if (n === 'available' || n === 'on air' || n === 'on-air' || n === 'onair') return 'Available';
  if (n === 'busy' || n === 'poc' || n === 'ems supervisor/poc' || n === 'ems supervisor poc') return 'Busy';
  return titleCase(statusText);
}

/* ---------- fetch + normalize ---------- */
async function fetchUnits(){
  const url = PROXY.replace(/\/$/,'') + '/units?t=' + Date.now();
  const r = await fetch(url, { cache: 'no-store', mode: 'cors' });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

function normalize(payload){
  const rows = Array.isArray(payload?.records) ? payload.records : [];
  const byUnit = new Map();

  for (const rec of rows){
    const unitRaw = String(rec.cad_unit || '');
    const unit = normalizeUnit(unitRaw);
    if (!ALLOW_UNITS.has(unit)) continue;

    const statusText = mapStatus(rec.status, rec.status_desc);

    // Hide Off Duty unless sticky
    if (!STICKY_UNITS.includes(unit) && isOffDuty(statusText)) continue;

    byUnit.set(unit, {
      cad_unit_raw: unitRaw || unit,
      cad_unit: unit,
      statusText,
      details: rec.details ?? '',
      cfs_num: rec.cfs_num ?? rec.incidentname ?? '',
      location: rec.location ?? rec.incident_location ?? ''
    });
  }

  // Ensure sticky units always present
  for (const u of STICKY_UNITS){
    if (!byUnit.has(u)){
      byUnit.set(u, { cad_unit_raw: u, cad_unit: u, statusText:'', details:'', cfs_num:'', location:'' });
    }
  }

  // Sort by unit id
  return Array.from(byUnit.values()).sort((a,b)=>naturalAZ(a.cad_unit,b.cad_unit));
}

/* ---------- render: desktop table ---------- */
function renderTable(rows){
  const tb = $('#tbody'); tb.innerHTML = '';
  if (!rows.length){ tb.innerHTML = '<tr><td colspan="5" class="muted">No data</td></tr>'; return; }
  for (const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="code nowrap">${esc(r.cad_unit_raw)}</td>
      <td>${esc(r.statusText)}</td>
      <td class="wrap">${esc(r.details)}</td>
      <td class="code nowrap">${esc(r.cfs_num)}</td>
      <td class="wrap">${esc(r.location)}</td>`;
    tb.appendChild(tr);
  }
}

/* ---------- render: mobile grouped cards ---------- */
function renderCards(rows){
  const container = $('#sections'); container.innerHTML = '';

  // Group rows
  const groups = new Map();
  for (const r of rows){
    const gName = groupNameFor(r.statusText || '');
    if (!groups.has(gName)) groups.set(gName, []);
    groups.get(gName).push(r);
  }

  // Order: Available, Busy, then alphabetical others
  const names = Array.from(groups.keys());
  names.sort((a,b)=>{
    const rank = n => (n==='Available'?0 : n==='Busy'?1 : 2);
    if (rank(a) !== rank(b)) return rank(a)-rank(b);
    return a.localeCompare(b);
  });

  for (const name of names){
    const list = groups.get(name).sort((a,b)=>naturalAZ(a.cad_unit,b.cad_unit));
    const section = document.createElement('section');
    section.className = 'section';

    const hdr = document.createElement('div');
    hdr.className = 'section-hdr';
    hdr.innerHTML = `<span class="count-pill">${list.length}</span><span>${esc(name)}</span>`;
    section.appendChild(hdr);

    const cards = document.createElement('div');
    cards.className = 'cards';

    for (const r of list){
      const color = STATUS_COLORS.colorFor(r.statusText);
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="unit-line">
          <span class="unit-id code">${esc(r.cad_unit_raw)}</span>
          <span class="status-badge" style="color:${color}">${esc(r.statusText || '')}</span>
        </div>
        <div class="line wrap">${esc(r.location || '')}</div>
        <div class="line wrap">${esc(r.details || '')}</div>
        <div class="line small code">CFS: ${esc(r.cfs_num || '')}</div>
      `;
      cards.appendChild(card);
    }

    section.appendChild(cards);
    container.appendChild(section);
  }
}

/* ---------- tick ---------- */
async function tick(){
  try{
    $('#error').hidden = true;
    const payload = await fetchUnits();
    const rows = normalize(payload);
    renderTable(rows);
    renderCards(rows);
    $('#lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
  }catch(e){
    $('#error').hidden = false;
    $('#error').textContent = 'Error: ' + (e.message || e);
  }
}

(async function start(){
  await loadStatusMap();  // harmless if json absent
  await tick();
  setInterval(tick, 5000);
})();
</script>
</body>
</html>
