<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Units — OCEMS</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root{ --rowPad:.9rem }
    body{font-size:22px}
    header .container{padding:1rem 2rem}
    h1{font-size:1.5rem}
    table{font-size:1.1rem}
    thead th{padding:var(--rowPad)}
    tbody td{padding:var(--rowPad)}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .nowrap{white-space:nowrap}
    .wrap{white-space:normal;word-break:break-word}
  </style>
</head>
<body>
<header>
  <div class="container">
    <h1>OCEMS — Unit Statuses</h1>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/units.html">Units</a>
      <a href="/current-cfs.html">Current CFS</a>
    </nav>
    <div class="meta">
      <span id="lastUpdated">Last updated: —</span>
      <span id="error" class="error" hidden></span>
    </div>
  </div>
</header>

<main class="container">
  <table>
    <thead>
    <tr>
      <th>CAD Unit</th>
      <th>Status</th>
      <th>Details</th>
      <th>CFS #</th>
      <th>Location</th>
    </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="5" class="muted">Loading…</td></tr>
    </tbody>
  </table>
</main>

<script>
/* show any error on screen */
(function(){
  function showErr(label, detail){
    let el = document.getElementById('error');
    if (!el) {
      el = document.createElement('pre');
      el.id = 'error';
      el.style.color = '#ff6b6b';
      el.style.padding = '1rem';
      el.style.whiteSpace = 'pre-wrap';
      document.body.prepend(el);
    }
    el.hidden = false;
    el.textContent = '['+label+'] ' + (detail?.message || detail || '');
  }
  window.addEventListener('error', e => showErr('JS Error', e.error || e.message));
  window.addEventListener('unhandledrejection', e => showErr('Promise Rejection', e.reason));
})();

/* ---------- CONFIG ---------- */
const PROXY = 'https://api.stancfhole.com'; // <- your custom API domain

// Sticky units — ALWAYS shown (even if not present)
const STICKY_UNITS = ['M931','M932','M933','M934','M935','M936','M937','M938','M939'];

// Allowed units; non-sticky hidden if "Off Duty"
const ALLOW_UNITS = new Set([
  ...STICKY_UNITS,
  '93','93HLD','905','906','907','908','909','911','912','913','914','915','917','918','919','920','921','922',
  '924','925','926','927','928','929','940','941','943','947','956',
  '9301','9302','9303','9304','9305','9306','9307','9308','9309','9310','9311','9312','9313','9314','9315','9316','9317',
  '9320','9321','9322','9323','9324','9325','9326','9327','9328','9329','9330','9331','9332','9333','9334','9335','9336','9337','9338','9339',
  '9340','9341','9342','9343','9344','9345','9346','9347','9348','9349',
  '9350','9351','9352','9353','9354','9355','9356',
  '9383','9391','9392'
]);

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
function esc(s){ s = s==null? '' : String(s);
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function naturalAZ(a,b){ return String(a).localeCompare(String(b), undefined, {numeric:true, sensitivity:'base'}); }
function normalizeUnit(u){ return String(u||'').replace(/[^A-Za-z0-9]/g,''); } // strip "~" etc.
function isOffDuty(text){ return String(text||'').toLowerCase().replace(/\s+/g,'') === 'offduty'; }

/* optional local status mapping if unit_statuses.json exists */
let STATUS_MAP=null;
async function loadStatusMap(){
  try { const r=await fetch('/unit_statuses.json',{cache:'no-store'}); if(r.ok) STATUS_MAP=await r.json(); } catch{}
}
function mapStatus(code, desc){
  if (desc && String(desc).trim()) return String(desc);
  if (!code || !STATUS_MAP) return String(code||'');
  const k = String(code);
  return STATUS_MAP[k]?.text || STATUS_MAP[k.toUpperCase?.()]?.text || k;
}

/* ---------- fetch + render ---------- */
async function fetchUnits(){
  const url = PROXY.replace(/\/$/,'') + '/units?t=' + Date.now();
  const r = await fetch(url, { cache: 'no-store' });
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

function normalize(payload){
  const rows = Array.isArray(payload?.records) ? payload.records : [];
  const byUnit = new Map();
  for (const rec of rows){
    const unitRaw = String(rec.cad_unit || '');
    const unit = normalizeUnit(unitRaw);
    if (!ALLOW_UNITS.has(unit)) continue;

    const statusText = mapStatus(rec.status, rec.status_desc);
    if (!STICKY_UNITS.includes(unit) && isOffDuty(statusText)) continue;

    byUnit.set(unit, {
      cad_unit_raw: unitRaw || unit,
      cad_unit: unit,
      statusText,
      details: rec.details ?? '',
      cfs_num: rec.cfs_num ?? rec.incidentname ?? '',
      location: rec.location ?? rec.incident_location ?? ''
    });
  }

  for (const u of STICKY_UNITS){
    if (!byUnit.has(u)){
      byUnit.set(u, { cad_unit_raw: u, cad_unit: u, statusText:'', details:'', cfs_num:'', location:'' });
    }
  }
  return Array.from(byUnit.values()).sort((a,b)=>naturalAZ(a.cad_unit,b.cad_unit));
}

function render(rows){
  const tb = $('#tbody'); tb.innerHTML = '';
  if (!rows.length){ tb.innerHTML = '<tr><td colspan="5" class="muted">No data</td></tr>'; return; }
  for (const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="code nowrap">${esc(r.cad_unit_raw)}</td>
      <td>${esc(r.statusText)}</td>
      <td class="wrap">${esc(r.details)}</td>
      <td class="code nowrap">${esc(r.cfs_num)}</td>
      <td class="wrap">${esc(r.location)}</td>`;
    tb.appendChild(tr);
  }
}

async function tick(){
  try{
    $('#error').hidden = true;
    const payload = await fetchUnits();
    render(normalize(payload));
    $('#lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
  }catch(e){
    $('#error').hidden = false;
    $('#error').textContent = 'Error: ' + (e.message || e);
  }
}

(async function start(){
  await loadStatusMap();  // harmless if file missing
  await tick();
  setInterval(tick, 5000);
})();
</script>
</body>
</html>
