<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Current CFS — Kiosk</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#000; --bg2:#0a0a0a; --bg3:#070707;
    --text:#E6E6E6; --muted:#A0A6AD; --border:#1b1b1b;
    --padY:.50rem; --padX:.65rem;
    --fz: clamp(16px, 1.7vw, 22px);
  }
  html,body{
    margin:0;background:var(--bg);color:var(--text);
    font:400 var(--fz)/1.25 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow:hidden;
  }
  .topbar{position:fixed;top:.5rem;right:.8rem;font-size:.85em;color:var(--muted);z-index:10}
  .panel{
    margin:.8rem; padding:0;
    border:1px solid var(--border);
    border-radius:14px; background: var(--bg2);
    box-shadow: 0 8px 24px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .panel .stripe{ height:3px; background: linear-gradient(90deg,#0ea5e9, #22d3ee, #38bdf8); }
  #wrap{transform-origin: top left; width:calc(100vw - 1.6rem);}
  table{width:100%;border-collapse:collapse;table-layout:auto}
  thead th{
    position:sticky;top:0;background:var(--bg2);
    border-bottom:1px solid var(--border);
    text-align:left;font-weight:700;letter-spacing:.02em;
    padding:var(--padY) var(--padX)
  }
  tbody tr:nth-child(odd){ background: var(--bg2); }
  tbody tr:nth-child(even){ background: var(--bg3); }
  tbody td{ padding:var(--padY) var(--padX); border-bottom:1px solid #111; vertical-align:top }
  .chips{display:flex;flex-wrap:wrap;gap:.25rem .35rem}
  .chip{border:1px solid #2a2a2a;border-radius:999px;padding:.05rem .45rem;background:#0e0e0e;
        font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,Roboto Mono,monospace;font-size:.9em}
  .code{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,Roboto Mono,monospace}
  .badge{
    display:inline-block; padding:.05rem .5rem; border-radius:999px;
    border:1px solid var(--bd, #333); color:var(--fg, #e6e6e6);
    background: var(--bgc, transparent); font-weight:600;
  }
</style>
</head>
<body>
<div class="topbar"><span id="updated">—</span></div>

<div class="panel" id="panel">
  <div class="stripe"></div>
  <div id="wrap">
    <table>
      <thead>
        <tr>
          <th>Incident</th>
          <th>Status</th>
          <th>Units Assigned</th>
          <th>Units Stacked</th>
          <th>Location</th>
          <th>Incident #</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="6" style="color:#888">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
/* ------- config ------- */
const PROXY = 'https://api.stancfhole.com';
const REFRESH_SEC = Number(new URLSearchParams(location.search).get('refresh') || 5);

/* helpers */
const $ = s => document.querySelector(s);
const esc = s => String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const str = x => x==null ? '' : String(x);
const norm = s => str(s).trim().toLowerCase().replace(/[_-]/g,' ').replace(/\s+/g,' ');
function toArray(x){ if(Array.isArray(x)) return x; if(!x) return []; return String(x).split(/[,\s]+/).map(v=>v.trim()).filter(Boolean); }

/* CSV loader for Incident Codes (full description mapping) */
let MAP=null;
function parseCSV(t){
  const rows=[]; let i=0,cur='',q=false,row=[];
  while(i<t.length){ const c=t[i++]; if(q){ if(c=='"'){ if(t[i]=='"'){cur+='"';i++;} else q=false; } else cur+=c; }
  else { if(c=='"') q=true; else if(c==','){row.push(cur);cur='';} else if(c=='\n'){row.push(cur);rows.push(row);row=[];cur='';}
  else if(c=='\r'){} else cur+=c; } } row.push(cur); rows.push(row); return rows.filter(r=>r.length && r.some(x=>x!=='')); }
async function loadMap(){
  try{
    const r = await fetch('/Incident%20Codes.csv',{cache:'no-store'});
    const text = await r.text(); const rows = parseCSV(text);
    const head = rows[0].map(h=>h.trim().toLowerCase());
    let ci=head.findIndex(h=>/^(code|incident ?code|short ?code)$/.test(h));
    let di=head.findIndex(h=>/^(description|desc|full|long|incident ?description)$/.test(h));
    if(ci<0) ci=0; if(di<0) di=1;
    MAP={};
    for(let i=1;i<rows.length;i++){
      const row=rows[i], code=str(row[ci]).trim(), desc=str(row[di]).trim();
      if(!code) continue;
      const key=code.toUpperCase().replace(/[^A-Z0-9]/g,'');
      MAP[key] = desc ? `${code} : ${desc}` : code;
    }
  }catch(e){ MAP={}; }
}
function fullIncident(code, fallback){
  const k=str(code).toUpperCase().replace(/[^A-Z0-9]/g,'');
  return (MAP && MAP[k]) ? MAP[k] : str(fallback || code);
}

/* status badge palette */
const STATUS_STYLE = (() => {
  const s = new Map();
  s.set('active',          {fg:'#3B82F6', bg:'rgba(59,130,246,.16)',  bd:'#1e3a8a'});
  s.set('open',            {fg:'#3B82F6', bg:'rgba(59,130,246,.16)',  bd:'#1e3a8a'});
  s.set('on scene',        {fg:'#F59E0B', bg:'rgba(245,158,11,.16)',  bd:'#7c2d12'});
  s.set('enroute',         {fg:'#60A5FA', bg:'rgba(96,165,250,.14)',  bd:'#1e3a8a'});
  s.set('assigned',        {fg:'#60A5FA', bg:'rgba(96,165,250,.14)',  bd:'#1e3a8a'});
  s.set('backup enroute',  {fg:'#60A5FA', bg:'rgba(96,165,250,.14)',  bd:'#1e3a8a'});
  s.set('transporting',    {fg:'#A78BFA', bg:'rgba(167,139,250,.18)', bd:'#4c1d95'});
  s.set('to hospital',     {fg:'#A78BFA', bg:'rgba(167,139,250,.18)', bd:'#4c1d95'});
  s.set('at hospital',     {fg:'#C084FC', bg:'rgba(192,132,252,.18)', bd:'#5b21b6'});
  s.set('staged',          {fg:'#FBBF24', bg:'rgba(251,191,36,.16)',  bd:'#78350f'});
  s.set('stacked',         {fg:'#FDE047', bg:'rgba(253,224,71,.12)',  bd:'#713f12'});
  s.set('in area',         {fg:'#22D3EE', bg:'rgba(34,211,238,.16)',  bd:'#155e75'});
  s.set('cancelled',       {fg:'#9CA3AF', bg:'rgba(156,163,175,.12)', bd:'#374151'});
  s.set('canceled',        {fg:'#9CA3AF', bg:'rgba(156,163,175,.12)', bd:'#374151'});
  s.set('closed',          {fg:'#9CA3AF', bg:'rgba(156,163,175,.12)', bd:'#374151'});
  s.set('cleared',         {fg:'#9CA3AF', bg:'rgba(156,163,175,.12)', bd:'#374151'});
  return { for:x => s.get(norm(x)) || {fg:'#E6E6E6', bg:'rgba(255,255,255,.06)', bd:'#333'} };
})();

/* fetch + normalize */
async function fetchCFS(){
  const r = await fetch(PROXY.replace(/\/$/,'')+'/current-cfs?t='+Date.now(), {cache:'no-store', mode:'cors'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}
function normalize(payload){
  const rows = Array.isArray(payload?.records)?payload.records:[];
  const out=[];
  for(const rec of rows){
    out.push({
      incident: fullIncident(rec.incident_code || rec.code, rec.incident_code_desc || rec.incident || rec.description),
      status: str(rec.status || rec.incident_status || 'Active'),
      units: toArray(rec.units || rec.units_assigned || rec.cad_units || rec.unit_list),
      stacked: toArray(rec.units_stacked || rec.stacked_units || rec.unitsstacked || rec.stacked),
      location: str(rec.location || rec.incident_location || rec.address || ''),
      cfs: str(rec.cfs_num || rec.cfs || rec.incidentnumber || rec.id)
    });
  }
  out.sort((a,b)=> b.cfs.localeCompare(a.cfs,undefined,{numeric:true,sensitivity:'base'}));
  return out;
}
function render(rows){
  const tb = $('#tbody'); tb.innerHTML='';
  for(const r of rows){
    const st = STATUS_STYLE.for(r.status);
    const unitsHtml = r.units.map(u=>`<span class="chip">${esc(u)}</span>`).join(' ');
    const stackedHtml = r.stacked.map(u=>`<span class="chip">${esc(u)}</span>`).join(' ');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(r.incident)}</td>
      <td><span class="badge" style="--fg:${st.fg};--bd:${st.bd};--bgc:${st.bg}">${esc(r.status)}</span></td>
      <td><div class="chips">${unitsHtml || '<span style="color:#888">—</span>'}</div></td>
      <td><div class="chips">${stackedHtml || '<span style="color:#888">—</span>'}</div></td>
      <td>${esc(r.location)}</td>
      <td class="code">${esc(r.cfs)}</td>`;
    tb.appendChild(tr);
  }
}

/* scale to fit (no scrolling) */
function fitToScreen(){
  const wrap = document.getElementById('wrap');
  wrap.style.transform='scale(1)'; wrap.style.width='calc(100vw - 1.6rem)';
  const need = wrap.scrollHeight, have = window.innerHeight - 1.6*16;
  const scale = Math.min(1, have / (need + 2));
  wrap.style.transform = `scale(${scale})`;
  wrap.style.width = (100/scale) + 'vw';
}

async function tick(){
  const data = await fetchCFS();
  const rows = normalize(data);
  render(rows);
  document.getElementById('updated').textContent = new Date().toLocaleTimeString();
  fitToScreen();
}

(async function start(){
  await loadMap();      // <- keeps your Incident Codes.csv mapping
  await tick();
  setInterval(()=>tick().catch(console.error), REFRESH_SEC*1000);
})();
window.addEventListener('resize', fitToScreen);
</script>
</body>
</html>
